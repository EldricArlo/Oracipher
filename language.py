# language.py

import logging
from typing import Dict

logger = logging.getLogger(__name__)

class LanguageManager:
    """
    ç®¡ç†åº”ç”¨ç¨‹åºä¸­çš„æ‰€æœ‰UIæ–‡æœ¬ç¿»è¯‘ã€‚
    """
    def __init__(self) -> None:
        self._language: str = 'en'
        self.TRANSLATIONS: Dict[str, Dict[str, str]] = {
            'en': {
                'app_title': "SafeKey",
                'button_ok': "OK",
                'button_save': "Save",
                'button_cancel': "Cancel",
                'button_generate': "Generate",
                'button_show': "Show",
                'button_hide': "Hide",
                'button_copy': "Copy",
                'button_copied': "Copied!",
                'button_done': "Done",
                'label_name': "Account Name",
                'label_user': "Username / Email",
                'label_pass': "Password",
                'label_cat': "Category",
                'label_notes': "Notes",
                'default_category': "Uncategorized",
                'label_url': "URL (for icon)",
                'setup_welcome': "Welcome to SafeKey",
                'setup_instruction': "Please create a master password to encrypt all your data.\nThis password is very important, remember it well.",
                'setup_placeholder': "Set Master Password (min. 8 chars, mixed)",
                'setup_confirm_placeholder': "Confirm Master Password",
                'setup_button': "Create Vault",
                'setup_success_title': "Success",
                'setup_success_msg': "Vault created! Please unlock with your new master password.",
                'unlock_welcome': "Welcome Back",
                'unlock_placeholder': "Master Password",
                'unlock_button': "Unlock",
                'button_exit': "Exit",
                'error_title_generic': "Error",
                'error_title_weak_password': "Weak Password",
                'error_title_mismatch': "Passwords Do Not Match",
                'error_msg_weak_password': "Password must be at least 8 characters and contain uppercase, lowercase, and digits.",
                'error_msg_mismatch': "The passwords entered do not match!",
                'error_msg_wrong_password': "Incorrect master password!",
                'search_placeholder': "Search...",
                'all_categories': "All Items",
                'details_placeholder': "Select an item from the list",
                'button_add_icon': "ï¼‹",
                'button_edit_icon': "âœŽ",
                'button_delete_icon': "ðŸ—‘",
                'button_settings': "Settings",
                'button_generate_password': "Generate Password",
                'button_add_account': "Add Account",
                'button_minimize': "â€”",
                'msg_title_input_error': "Input Error",
                'msg_empty_name_error': "Account name cannot be empty.",
                'msg_title_confirm_delete': "Confirm Deletion",
                'msg_confirm_delete': "Are you sure you want to delete '{name}'?",
                'msg_title_pass_change_success': "Success",
                'msg_pass_change_success': "Master password has been changed successfully!",
                'msg_title_pass_change_fail': "Operation Failed",
                'msg_pass_change_fail_old_wrong': "The old master password is not correct!",
                'msg_pass_change_fail_mismatch': "The new passwords do not match!",
                'msg_pass_change_fail_weak': "New password is too weak. It must be at least 8 characters and contain uppercase, lowercase, and digits.",
                'msg_pass_change_fail_empty': "All password fields are required.",
                'add_title': "Add New Entry",
                'edit_title': "Edit Entry",
                'placeholder_name': "e.g., Google",
                'placeholder_user': "e.g., user@example.com",
                'placeholder_url': "e.g., www.google.com",
                'placeholder_cat': "e.g., Work",
                'button_fetch_icon': "Fetch Icon",
                'button_custom_icon': "Custom Icon",
                'tooltip_custom_icon': "Click to set a custom icon",
                'error_url_required': "Please enter a valid URL to fetch an icon.",
                'error_fetch_failed': "Could not fetch an icon from this URL. Please check the URL and your network connection.",
                'error_loading_icon': "There was an error loading the selected icon file.",
                'dialog_select_icon': "Select an Icon File",
                'dialog_image_files': "Image Files",
                'gen_title': "Password Generator",
                'gen_label_len': "Length: {length}",
                'gen_check_upper': "Uppercase (A-Z)",
                'gen_check_num': "Numbers (0-9)",
                'gen_check_sym': "Symbols (!@#$)",
                'gen_no_charset': "Please select a character set",
                'change_pass_title': "Change Master Password",
                'label_old_pass': "Old Password",
                'label_new_pass': "New Password",
                'label_confirm_pass': "Confirm New",
                'placeholder_old_pass': "Enter your current master password",
                'placeholder_new_pass': "Set a new master password",
                'placeholder_confirm_pass': "Confirm the new master password",
                'settings_title': "Settings",
                'settings_lang_label': "Language",
                'settings_restart_msg': "Language settings saved. Please restart the application for changes to take effect.",
                'label_data_management': "Data Management",
                'button_import': "Import Data",
                'button_export': "Export Data",
                'dialog_export_title': "Export Vault",
                'dialog_import_title': "Import Vault",
                'dialog_csv_files': "CSV Files",
                'msg_export_success_title': "Export Successful",
                'msg_export_success': "{count} entries have been successfully exported to:\n{path}",
                'msg_export_fail_title': "Export Failed",
                'msg_export_fail': "An error occurred during export: {error}",
                'msg_import_confirm_title': "Confirm Import",
                'msg_import_confirm': "You are about to import entries from a CSV file.\n\n- Entries with new names will be added.\n- Entries with names that already exist will be OVERWRITTEN.\n\nThis action cannot be undone. Are you sure you want to continue?",
                'msg_import_success_title': "Import Successful",
                'msg_import_success': "{count} entries have been successfully imported.",
                'msg_import_fail_title': "Import Failed",
                'msg_import_fail': "An error occurred during import: {error}",
            },
            'zh_CN': {
                'app_title': "SafeKey",
                'button_ok': "ç¡® å®š",
                'button_save': "ä¿ å­˜",
                'button_cancel': "å– æ¶ˆ",
                'button_generate': "ç”Ÿæˆ",
                'button_show': "æ˜¾ç¤º",
                'button_hide': "éšè—",
                'button_copy': "å¤åˆ¶",
                'button_copied': "å·²å¤åˆ¶!",
                'button_done': "å®Œ æˆ",
                'label_name': "è´¦æˆ·åç§°",
                'label_user': "ç”¨æˆ·å/é‚®ç®±",
                'label_pass': "å¯†ç ",
                'label_cat': "åˆ†ç±»",
                'label_notes': "å¤‡æ³¨",
                'default_category': "æœªåˆ†ç±»",
                'label_url': "ç½‘å€ (ç”¨äºŽèŽ·å–å›¾æ ‡)",
                'setup_welcome': "æ¬¢è¿Žä½¿ç”¨ SafeKey",
                'setup_instruction': "è¯·åˆ›å»ºä¸€ä¸ªç”¨äºŽåŠ å¯†æ‚¨æ‰€æœ‰æ•°æ®çš„ä¸»å¯†ç ã€‚\nè¿™ä¸ªå¯†ç éžå¸¸é‡è¦ï¼Œè¯·åŠ¡å¿…ç‰¢è®°ã€‚",
                'setup_placeholder': "è®¾ç½®ä¸»å¯†ç  (è‡³å°‘8ä½ï¼Œå»ºè®®åŒ…å«æ··åˆå­—ç¬¦)",
                'setup_confirm_placeholder': "ç¡®è®¤ä¸»å¯†ç ",
                'setup_button': "åˆ›å»ºä¿é™©åº“",
                'setup_success_title': "æˆåŠŸ",
                'setup_success_msg': "ä¿é™©åº“å·²åˆ›å»ºï¼è¯·ä½¿ç”¨æ‚¨çš„æ–°ä¸»å¯†ç è§£é”ã€‚",
                'unlock_welcome': "æ¬¢è¿Žå›žæ¥",
                'unlock_placeholder': "ä¸»å¯†ç ",
                'unlock_button': "è§£ é”",
                'button_exit': "é€€ å‡º",
                'error_title_generic': "é”™è¯¯",
                'error_title_weak_password': "å¯†ç å¼ºåº¦ä¸è¶³",
                'error_title_mismatch': "å¯†ç ä¸åŒ¹é…",
                'error_msg_weak_password': "å¯†ç å¿…é¡»è‡³å°‘8ä½ï¼Œä¸”åŒ…å«å¤§å†™å­—æ¯ã€å°å†™å­—æ¯å’Œæ•°å­—ã€‚",
                'error_msg_mismatch': "ä¸¤æ¬¡è¾“å…¥çš„å¯†ç ä¸ä¸€è‡´ï¼",
                'error_msg_wrong_password': "ä¸»å¯†ç é”™è¯¯ï¼",
                'search_placeholder': "æœç´¢...",
                'all_categories': "æ‰€æœ‰é¡¹ç›®",
                'details_placeholder': "ä»Žåˆ—è¡¨ä¸­é€‰æ‹©ä¸€ä¸ªé¡¹ç›®",
                'button_add_icon': "ï¼‹",
                'button_edit_icon': "âœŽ",
                'button_delete_icon': "ðŸ—‘",
                'button_settings': "è®¾ ç½®",
                'button_generate_password': "åˆ›å»ºå¼ºå¯†ç ",
                'button_add_account': "æ·»åŠ è´¦æˆ·",
                'button_minimize': "â€”",
                'msg_title_input_error': "è¾“å…¥é”™è¯¯",
                'msg_empty_name_error': "è´¦æˆ·åç§°ä¸èƒ½ä¸ºç©ºã€‚",
                'msg_title_confirm_delete': "ç¡®è®¤åˆ é™¤",
                'msg_confirm_delete': "æ‚¨ç¡®å®šè¦åˆ é™¤ '{name}' å—ï¼Ÿ",
                'msg_title_pass_change_success': "æˆåŠŸ",
                'msg_pass_change_success': "ä¸»å¯†ç å·²æˆåŠŸä¿®æ”¹ï¼",
                'msg_title_pass_change_fail': "æ“ä½œå¤±è´¥",
                'msg_pass_change_fail_old_wrong': "æ—§ä¸»å¯†ç ä¸æ­£ç¡®ï¼",
                'msg_pass_change_fail_mismatch': "ä¸¤æ¬¡è¾“å…¥çš„æ–°å¯†ç ä¸ä¸€è‡´ï¼",
                'msg_pass_change_fail_weak': "æ–°å¯†ç å¼ºåº¦ä¸è¶³ã€‚å¿…é¡»è‡³å°‘8ä½ï¼Œä¸”åŒ…å«å¤§å†™å­—æ¯ã€å°å†™å­—æ¯å’Œæ•°å­—ã€‚",
                'msg_pass_change_fail_empty': "æ‰€æœ‰å¯†ç å­—æ®µå‡ä¸èƒ½ä¸ºç©ºã€‚",
                'add_title': "æ·»åŠ æ–°æ¡ç›®",
                'edit_title': "ç¼–è¾‘æ¡ç›®",
                'placeholder_name': "ä¾‹å¦‚: Google",
                'placeholder_user': "ä¾‹å¦‚: user@example.com",
                'placeholder_url': "ä¾‹å¦‚: www.google.com",
                'placeholder_cat': "ä¾‹å¦‚: å·¥ä½œ",
                'button_fetch_icon': "èŽ·å–å›¾æ ‡",
                'button_custom_icon': "è‡ªå®šä¹‰å›¾æ ‡",
                'tooltip_custom_icon': "ç‚¹å‡»è®¾ç½®è‡ªå®šä¹‰å›¾æ ‡",
                'error_url_required': "è¯·è¾“å…¥æœ‰æ•ˆçš„ç½‘å€ä»¥èŽ·å–å›¾æ ‡ã€‚",
                'error_fetch_failed': "æ— æ³•ä»Žè¯¥ç½‘å€èŽ·å–å›¾æ ‡ï¼Œè¯·æ£€æŸ¥ç½‘å€æˆ–ç½‘ç»œè¿žæŽ¥ã€‚",
                'error_loading_icon': "åŠ è½½æ‰€é€‰å›¾æ ‡æ–‡ä»¶æ—¶å‡ºé”™ã€‚",
                'dialog_select_icon': "é€‰æ‹©ä¸€ä¸ªå›¾æ ‡æ–‡ä»¶",
                'dialog_image_files': "å›¾ç‰‡æ–‡ä»¶",
                'gen_title': "å¯†ç ç”Ÿæˆå™¨",
                'gen_label_len': "é•¿åº¦: {length}",
                'gen_check_upper': "å¤§å†™å­—æ¯ (A-Z)",
                'gen_check_num': "æ•°å­— (0-9)",
                'gen_check_sym': "ç¬¦å· (!@#$)",
                'gen_no_charset': "è¯·é€‰æ‹©å­—ç¬¦é›†",
                'change_pass_title': "ä¿®æ”¹ä¸»å¯†ç ",
                'label_old_pass': "æ—§ä¸»å¯†ç ",
                'label_new_pass': "æ–°ä¸»å¯†ç ",
                'label_confirm_pass': "ç¡®è®¤æ–°å¯†ç ",
                'placeholder_old_pass': "è¾“å…¥æ‚¨å½“å‰çš„ä¸»å¯†ç ",
                'placeholder_new_pass': "è®¾ç½®æ–°ä¸»å¯†ç ",
                'placeholder_confirm_pass': "å†æ¬¡è¾“å…¥æ–°ä¸»å¯†ç ",
                'settings_title': "è®¾ç½®",
                'settings_lang_label': "è¯­è¨€",
                'settings_restart_msg': "è¯­è¨€è®¾ç½®å·²ä¿å­˜ã€‚è¯·é‡å¯åº”ç”¨ç¨‹åºä»¥ä½¿æ›´æ”¹ç”Ÿæ•ˆã€‚",
                'label_data_management': "æ•°æ®ç®¡ç†",
                'button_import': "å¯¼å…¥æ•°æ®",
                'button_export': "å¯¼å‡ºæ•°æ®",
                'dialog_export_title': "å¯¼å‡ºä¿é™©åº“",
                'dialog_import_title': "å¯¼å…¥ä¿é™©åº“",
                'dialog_csv_files': "CSV æ–‡ä»¶",
                'msg_export_success_title': "å¯¼å‡ºæˆåŠŸ",
                'msg_export_success': "{count} ä¸ªæ¡ç›®å·²æˆåŠŸå¯¼å‡ºåˆ°:\n{path}",
                'msg_export_fail_title': "å¯¼å‡ºå¤±è´¥",
                'msg_export_fail': "å¯¼å‡ºè¿‡ç¨‹ä¸­å‘ç”Ÿé”™è¯¯: {error}",
                'msg_import_confirm_title': "ç¡®è®¤å¯¼å…¥",
                'msg_import_confirm': "æ‚¨å³å°†ä»Ž CSV æ–‡ä»¶å¯¼å…¥æ¡ç›®ã€‚\n\n- åç§°ä¸é‡å¤çš„æ¡ç›®å°†è¢«æ–°å¢žã€‚\n- åç§°å·²å­˜åœ¨çš„æ¡ç›®å°†è¢«è¦†ç›–ã€‚\n\næ­¤æ“ä½œæ— æ³•æ’¤é”€ï¼Œæ‚¨ç¡®å®šè¦ç»§ç»­å—ï¼Ÿ",
                'msg_import_success_title': "å¯¼å…¥æˆåŠŸ",
                'msg_import_success': "{count} ä¸ªæ¡ç›®å·²æˆåŠŸå¯¼å…¥ã€‚",
                'msg_import_fail_title': "å¯¼å…¥å¤±è´¥",
                'msg_import_fail': "å¯¼å…¥è¿‡ç¨‹ä¸­å‘ç”Ÿé”™è¯¯: {error}",
            }
        }
    
    def set_language(self, lang_code: str) -> None:
        if lang_code in self.TRANSLATIONS:
            self._language = lang_code
        else:
            logger.warning(f"è¯­è¨€ä»£ç  '{lang_code}' æœªåœ¨ç¿»è¯‘åº“ä¸­æ‰¾åˆ°ã€‚å°†å›žé€€åˆ° 'en'ã€‚")
            self._language = 'en'

    def get(self, key: str, **kwargs) -> str:
        try:
            translation = self.TRANSLATIONS[self._language][key]
            if kwargs:
                return translation.format(**kwargs)
            return translation
        except KeyError:
            logger.warning(f"ç¿»è¯‘é”® '{key}' åœ¨è¯­è¨€ '{self._language}' ä¸­æœªæ‰¾åˆ°ã€‚")
            return key

    def get_available_languages(self) -> Dict[str, str]:
        return {
            'en': 'English',
            'zh_CN': 'ç®€ä½“ä¸­æ–‡'
        }

t = LanguageManager()